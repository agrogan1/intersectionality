---
title: "An **Early Days Rough Draft** Conversation About MAIHDA"
subtitle: "Multilevel Analysis Of Individual Heterogeneity And Discriminatory Accuracy"
author: "Andy Grogan-Kaylor"
date: "today"
format: 
  html: 
    toc: true
    number-sections: true
    lightbox: true
  pdf:
    toc: true
    number-sections: true
    fig-pos: H 
bibliography: intersectionality.bib
csl: apa.csl
nocite: |
  @Grogan-Kaylor2026
filters:
  - highlight-text
---

# Inspirations

```{r}
#| echo: false
#| output: false

library(Statamarkdown)

# stataexe <- "/Applications/StataNow/"
# 
# knitr::opts_chunk$set(engine.path=list(stata=stataexe))

```

> "My conception of the universal is that of a universal enriched by all that is particular, a universal enriched by every particular: the deepening and coexistence of all particulars." [@Cesaire1956]

Conceptual inspiration comes from sources such as @Cho2013, @Cesaire1956, @UNESCO1997, @Martin-Baro1998, @Montero2009, @Antweiler2016, @Stage2014, and @Scharrer2021.

Substantively and practically, this handout depends [**heavily**]{fg="#FF0000"} on the ideas, example code, and example data set in @Evans2024.

# The Basic Idea of Multilevel Modeling

```{r}
#| echo: false

set.seed(3846)

N <- 10 # individuals

N_t <- 3 # time points

id <- rep(seq(1, N), each = N_t)

t <- runif(N * N_t, min = 1, max = 10)

u0 <- id

e <- rnorm(N * N_t, 0, 1)

y <- t + u0 + e

mydata <- data.frame(id, t, y)

mydata$y[1] <- NA # wave missing

mydata$y[11] <- NA # wave missing

```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-MLM
#| fig-cap: "A Basic Multilevel Model"

library(ggplot2)

mycaption <- paste("Every Group Has Its Own Intercept And Slope",
                   "\n",
                   "Every Group Has Different Observations",
                   "\n",
                   "Groups Have Different Numbers of Observations")

ggplot(mydata,
       aes(x = t,
           y = y, 
           color = factor(id))) +
  geom_point(size = 3) +
  geom_smooth(method="lm",
              se = FALSE) +
  theme_minimal() +
  scale_color_viridis_d(name = "group",
                        option = "turbo") +
  labs(title = "A Basic Multilevel Model",
       subtitle = "Every Group Has Its Own Regression Line", 
       x = "x",
       caption = mycaption)

ggsave("multilevel.png")

```

# The Basic Idea Of MAIHDA

::: {.callout-tip}
## Key Ideas

The key ideas are as follows:

1. A *traditional* approach would ask us to generate multiple interaction terms to explore interactions e.g. $sex \times race \times education \times age$ as well as all of the lower level 2 and 3 -way interactions. Upon first glance this seems unwieldy, though in a future discussion, we could talk about how some software (e.g. Stata) makes this approach less unwieldy than it might initially appear.
2. In contrast, **MAIHDA** uses combinations of variables to generate *strata* which are then treated as the levels in a multilevel model.
:::

# Get The Data

::: {.panel-tabset group="language"}
## Stata

```{stata, collectcode=TRUE}

use "TutorialData.dta" // get the data

describe // describe the data

```

## R

```{r}
#| echo: true
#| eval: true

library(haven) # read Stata

TutorialData <- read_dta("TutorialData.dta")

```
:::

# Generating The Strata

::: {.panel-tabset group="language"}
## Stata

```{stata, collectcode=TRUE}

generate stratum = 10000*sex + 1000*race + 100*education + 10*income + 1*age // create stratum variable

```

## R

```{r}
#| echo: true
#| eval: true
#| message: false

library(dplyr) # data wrangling

TutorialData <- TutorialData %>% 
  mutate(stratum = 10000*sex + 
           1000*race + 
           100*education + 
           10*income + 
           1*age) # create stratum variable

```
:::

# Empty or ANOVA Model

## Model

::: {.panel-tabset group="language"}
### Stata

```{stata, collectcode=TRUE}

mixed HbA1c || stratum: // ANOVA model

```

### R

```{r}
#| echo: true
#| eval: true

library(lme4)

fit1 <- lmer(HbA1c ~ (1 | stratum), data = TutorialData)

summary(fit1)

```
:::

## IntraClass Correlation Coefficient

::: {.callout-tip}
## The ICC

The ICC answers the question:  "How much clustering is there?"
:::

::: {.panel-tabset group="language"}
### Stata

```{stata}

estat icc // intraclass correlation coefficient

```

### R

```{r}
#| echo: true
#| eval: true

performance::icc(fit1) # ICC

```
:::

# Full Model

::: {.callout-tip}
## One Perspective

The results indicate a balance of main effects of structural factors and intersectionality.
:::

::: {.panel-tabset group="language"}
## Stata 

```{stata}

mixed HbA1c i.sex i.race i.education i.income i.age || stratum:

```

## R

```{r}
#| echo: true
#| eval: true

library(lme4)

TutorialData$sex <- factor(TutorialData$sex)
TutorialData$race <- factor(TutorialData$race)
TutorialData$education <- factor(TutorialData$education)
TutorialData$income <- factor(TutorialData$income)
TutorialData$age <- factor(TutorialData$age)

fit1 <- lmer(HbA1c ~ sex + race + education + income + age + (1 | stratum), data = TutorialData)

summary(fit1)

```
:::

# Discussion Questions

1. Clarifying what we mean by intersectionality before moving to quantitative approaches
2. What MAIHDA adds beyond conventional interaction models. (Do interactions fail to capture these ideas? Are multiple interactions so hard to test?)
3. The role of multilevel modeling and partial pooling
4. MAIHDA in descriptive vs. causal contexts
5. Broader model evaluation and potential extensions of the method (CF testing multiple interactions and maximal models ([https://agrogan1.github.io/multilevel/Bayesian-and-frequentist-MLM/Bayesian-and-frequentist-MLM.html#maximal-models](https://agrogan1.github.io/multilevel/Bayesian-and-frequentist-MLM/Bayesian-and-frequentist-MLM.html#maximal-models)))


::: {.content-visible when-format="pdf"}
# References
:::


